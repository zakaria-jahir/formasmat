{% extends 'core/base.html' %}
{% load static %}

{% block title %}Gestion des souhaits de formations{% endblock %}

{% block extra_css %}
<link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css" rel="stylesheet">
<style>
    .filter-section {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.25rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <h1 class="mb-4">Gestion des souhaits de formations</h1>

    <!-- Filtres -->
    <div class="filter-section mb-4">
        <div class="row">
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="formationFilter" class="form-label">Formation</label>
                    <select id="formationFilter" class="form-select">
                        <option value="">Toutes les formations</option>
                        {% for formation in formations %}
                            <option value="{{ formation.id }}">{{ formation.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="dateFilter" class="form-label">Période</label>
                    <select id="dateFilter" class="form-select">
                        <option value="">Toutes les périodes</option>
                        <option value="today">Aujourd'hui</option>
                        <option value="week">Cette semaine</option>
                        <option value="month">Ce mois</option>
                        <option value="year">Cette année</option>
                    </select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="statusFilter" class="form-label">Statut</label>
                    <select id="statusFilter" class="form-select">
                        <option value="">Tous les statuts</option>
                        <option value="pending">En attente</option>
                        <option value="assigned">Assigné</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <table id="wishesTable" class="table table-striped">
                <thead>
                    <tr>
                        <th>Utilisateur</th>
                        <th>Formation</th>
                        <th>Date de demande</th>
                        <th>Statut</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal pour assigner à une session -->
    <div class="modal fade" id="assignSessionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assigner à une session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="assignSessionForm" method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="sessionSelect" class="form-label">Session de formation</label>
                            <select id="sessionSelect" class="form-select" required>
                                <option value="">Choisir une session...</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="confirmAssign">Assigner</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- DataTables Core -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<!-- DataTables Buttons -->
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.bootstrap5.min.js"></script>

<!-- Export Plugins -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>

<script>
jQuery(document).ready(function($) {
    console.log('Initialisation de la table...');
    
    // Initialisation de la table avec DataTables
    var table = $('#wishesTable').DataTable({
        ajax: {
            url: '{% url "core:get_training_wishes" %}',
            data: function(d) {
                d.formation_id = $('#formationFilter').val();
                d.date_filter = $('#dateFilter').val();
                d.status = $('#statusFilter').val();
                return d;
            },
            dataSrc: function(json) {
                console.log('Données reçues:', json);
                return json;
            },
            error: function(xhr, error, thrown) {
                console.error('Erreur lors de la récupération des données:', error);
                console.error('Détails:', thrown);
                console.error('Réponse:', xhr.responseText);
            }
        },
        order: [[2, 'desc']], // Tri par défaut sur la date de demande
        columns: [
            { 
                data: 'user',
                render: function(data) {
                    return data.full_name || data.username;
                }
            },
            { data: 'formation.name' },
            { 
                data: 'created_at',
                render: function(data) {
                    return new Date(data).toLocaleDateString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            },
            {
                data: 'status',
                render: function(data) {
                    if (data === 'assigned') {
                        return '<span class="badge bg-success">Assigné</span>';
                    }
                    return '<span class="badge bg-warning">En attente</span>';
                }
            },
            { data: 'notes' },
            {
                data: null,
                render: function(data) {
                    let buttons = '';
                    if (data.status !== 'assigned') {
                        buttons += `<button class="btn btn-primary btn-sm assign-btn me-1" data-wish-id="${data.id}">
                            <i class="fas fa-user-plus"></i> Assigner
                        </button>`;
                    }
                    buttons += `<button class="btn btn-danger btn-sm delete-btn" data-wish-id="${data.id}">
                        <i class="fas fa-trash"></i>
                    </button>`;
                    return buttons;
                }
            }
        ],
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'excel',
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: 'btn btn-success btn-sm me-1'
            },
            {
                extend: 'pdf',
                text: '<i class="fas fa-file-pdf"></i> PDF',
                className: 'btn btn-danger btn-sm'
            }
        ],
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.11.5/i18n/fr-FR.json'
        }
    });

    // Gestion des filtres
    $('#formationFilter, #dateFilter, #statusFilter').change(function() {
        console.log('Filtre changé:', $(this).attr('id'), 'Valeur:', $(this).val());
        table.ajax.reload();
    });

    // Gestion du clic sur le bouton d'assignation
    $('#wishesTable').on('click', '.assign-btn', function() {
        var wishId = $(this).data('wish-id');
        var row = table.row($(this).closest('tr')).data();
        console.log('Assignation souhaitée pour le souhait:', wishId, 'Données:', row);
        
        // Récupérer les sessions disponibles
        $.get('{% url "core:get_formation_sessions" %}', { formation_id: row.formation.id })
        .done(function(sessions) {
    console.log('Sessions disponibles:', sessions);
    const select = $('#sessionSelect');
    select.empty().append('<option value="">Choisir une session...</option>');

    if (sessions.length === 0) {
        select.append('<option value="">Aucune session disponible</option>');
        return;
    }

    sessions.forEach(function(session) {
        if (session.start_date && session.end_date && session.formation && session.formation.name) {
            select.append(`<option value="${session.id}">
                ${session.formation.name} - Du ${new Date(session.start_date).toLocaleDateString('fr-FR')}
                au ${new Date(session.end_date).toLocaleDateString('fr-FR')}
            </option>`);
        }
    });

    $('#assignSessionModal')
        .data('wish-id', wishId)
        .modal('show');
})

            .fail(function(xhr) {
                console.error('Erreur lors de la récupération des sessions:', xhr);
                alert('Erreur lors de la récupération des sessions disponibles');
            });
    });

    // Gestion de l'assignation
    $('#confirmAssign').click(function() {
        var wishId = $('#assignSessionModal').data('wish-id');
        var sessionId = $('#sessionSelect').val();

        if (!sessionId) {
            alert('Veuillez sélectionner une session');
            return;
        }

        console.log('Confirmation assignation:', wishId, 'à la session:', sessionId);
        $.post('{% url "core:assign_to_session" %}', {
            wish_id: wishId,
            session_id: sessionId,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        })
        .done(function(response) {
            console.log('Assignation réussie:', response);
            $('#assignSessionModal').modal('hide');
            table.ajax.reload();
            alert('Utilisateur assigné avec succès !');
        })
        .fail(function(xhr) {
            console.error('Erreur lors de l\'assignation:', xhr);
            alert('Erreur lors de l\'assignation : ' + (xhr.responseJSON?.error || 'Erreur inconnue'));
        });
    });

    // Gestion de la suppression
    $('#wishesTable').on('click', '.delete-btn', function() {
        if (confirm('Êtes-vous sûr de vouloir supprimer ce souhait ?')) {
            var wishId = $(this).data('wish-id');
            console.log('Suppression souhaitée pour le souhait:', wishId);
            $.post('{% url "core:delete_wish" pk=0 %}'.replace('0', wishId), {
                csrfmiddlewaretoken: '{{ csrf_token }}'
            })
            .done(function() {
                console.log('Suppression réussie');
                table.ajax.reload();
            })
            .fail(function(xhr) {
                console.error('Erreur lors de la suppression:', xhr);
                alert('Erreur lors de la suppression : ' + (xhr.responseJSON?.error || 'Erreur inconnue'));
            });
        }
    });
});
</script>
{% endblock %}
